<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="mobile-web-app-capable" content="yes"/>
<title>Workout Rest Timer</title>
<link rel="icon" href="resttimer-roundcap-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
<link rel="icon" href="resttimer-roundcap-dark.svg"  type="image/svg+xml" media="(prefers-color-scheme: dark)">
<style>
  :root{
    --bg: #0f1419;
    --card: #141a21;
    --text: #eaf0f6;
    --muted:#9fb0c1;
    --ring:#2e7cf7;
    --ring-15:#ff8a22;
    --accent:#2e7cf7;
    --accent-press:#1f66d6;
    --btn:#1a2230;
    --btn-text:#eaf0f6;
    --pill:#10161d;
    --pill-border:#243040;
    --shadow: 0 4px 12px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.1);
    --warn-fill: rgba(255,138,34,.15);
  }
  .light{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#0b1722;
    --muted:#6b7c8d;
    --ring:#1f6eff;
    --ring-15:#ff7a1a;
    --accent:#1f6eff;
    --accent-press:#0d50c7;
    --btn:#e6e9ed;
    --btn-text:#171d27;
    --pill:#f0f2f5;
    --pill-border:#dadee3;
    --shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
    --warn-fill: rgba(255,122,26,.15);
  }
  .auto:not(.light){
    --bg:#0f1419;
    --card:#141a21;
    --text:#eaf0f6;
    --muted:#9fb0c1;
    --ring:#2e7cf7;
    --ring-15:#ff8a22;
    --accent:#2e7cf7;
    --accent-press:#1f66d6;
    --btn:#1a2230;
    --btn-text:#eaf0f6;
    --pill:#10161d;
    --pill-border:#243040;
    --shadow: 0 4px 12px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.1);
    --warn-fill: rgba(255,138,34,.15);
  }
  .auto.light{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#0b1722;
    --muted:#6b7c8d;
    --ring:#1f6eff;
    --ring-15:#ff7a1a;
    --accent:#1f6eff;
    --accent-press:#0d50c7;
    --btn:#e6e9ed;
    --btn-text:#171d27;
    --pill:#f0f2f5;
    --pill-border:#dadee3;
    --shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
    --warn-fill: rgba(255,122,26,.15);
  }
  @media (prefers-color-scheme: light) {
    .auto{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0b1722;
      --muted:#6b7c8d;
      --ring:#1f6eff;
      --ring-15:#ff7a1a;
      --accent:#1f6eff;
      --accent-press:#0d50c7;
      --btn:#e6e9ed;
      --btn-text:#171d27;
      --pill:#f0f2f5;
      --pill-border:#dadee3;
      --shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
      --warn-fill: rgba(255,122,26,.15);
    }
  }
  /* Reset */
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    color:var(--text);
    background:var(--bg);
    transition: background-color 0.3s, color 0.3s;
    padding: 0 16px;
  }
  *,*:before,*:after{ box-sizing:border-box; }
  h1,h2,p{ margin:0; }
  /* Layout */
  #root{
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 16px 0;
  }
  .card-container{
    display: flex;
    flex-direction: column;
    gap: 16px;
    background:var(--card);
    border-radius:24px;
    padding: 16px;
    margin-bottom: auto;
    box-shadow:var(--shadow);
    flex-grow:1;
  }
  .card{
    background:var(--card);
    border-radius:24px;
    padding: 16px;
    box-shadow:var(--shadow);
  }
  .main-timer{
    text-align:center;
    flex-grow:1;
    display:flex;
    flex-direction: column;
    justify-content:center;
    align-items:center;
    position:relative;
    width:100%;
    margin:12px 0;
  }
  .timer-content{
    display:flex;
    flex-direction:column;
    justify-content: center;
    align-items: center;
    position:absolute;
    top:0;left:0;right:0;bottom:0;
    font-size:32px;
    font-weight:600;
  }
  .timer-content h1{
    font-size:72px;
    line-height:1;
    font-weight:300;
    letter-spacing:-2px;
    margin-top: -6px;
  }
  .timer-content h1.pulse{
    animation: pulse 1s ease-in-out infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  .timer-content small{
    font-size:16px;
    line-height:1;
    color:var(--muted);
    font-weight:400;
    margin-top:12px;
  }
  svg.ring{
    width:100%;
    max-width:280px;
    stroke:var(--ring);
    transition:stroke 0.3s;
    transform:rotate(-90deg);
  }
  svg.ring circle{
    stroke-width:8px;
    fill:transparent;
    stroke-linecap:round;
  }
  .controls{
    display:flex;
    gap:8px;
    justify-content:center;
    align-items:center;
    margin-top:16px;
    width:100%;
  }
  .btn{
    padding:14px 18px;
    font-size:16px;
    font-weight:600;
    border-radius:12px;
    border:none;
    cursor:pointer;
    transition:transform 0.1s;
    white-space:nowrap;
    flex-shrink: 0;
  }
  .btn-primary{
    background:var(--accent);
    color:white;
    text-align:center;
    flex-grow: 1; /* Main button grows to fill space */
  }
  .btn-secondary{
    background:var(--btn);
    color:var(--btn-text);
  }
  .btn:active{ transform:scale(0.96); }
  .btn.hidden{ display:none; }
  .btn-nudge{
    width: 84px; /* Fixed width for nudge buttons to prevent overspill */
  }
  .row{
    display:flex;
    gap:12px;
    justify-content:center;
    align-items:center;
    flex-wrap: wrap;
  }
  .pills{
    display:flex;
    gap:8px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding:12px 0;
  }
  .pills::-webkit-scrollbar{ display:none; }
  .pill{
    background:var(--pill);
    border:1px solid var(--pill-border);
    border-radius:100px;
    padding:8px 16px;
    font-size:14px;
    white-space:nowrap;
    cursor:pointer;
    color:var(--text);
  }
  .pill.active{
    background:var(--accent);
    color:white;
    border-color:var(--accent);
  }
  .pill.complete{
    background:var(--pill);
    border-color:transparent;
    color:var(--muted);
  }
  .preset-btn{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background:var(--btn);
    color:var(--btn-text);
    border-radius:12px;
    padding:12px;
    font-weight:600;
    border:1px solid transparent;
    transition:transform 0.1s, border-color 0.2s;
    cursor:pointer;
    white-space:nowrap;
    flex: 1 1 0%;
    min-width: 0;
  }
  .preset-btn:active{ transform:scale(0.96); }
  .preset-btn.active{
    border-color:var(--accent);
  }
  .preset-btn .time-label{ font-size:16px; }
  .preset-btn .sets-label{
    font-size:12px;
    color:var(--muted);
    font-weight:500;
    margin-top:2px;
  }
  .preset-btn .sets-label::before{ content:'\00a0'; }
  .bottom-row{
    display:flex;
    gap:12px;
    margin-top:auto;
    justify-content:center;
  }
  .bottom-btn{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    color:var(--muted);
    font-size:12px;
    text-decoration:none;
    transition:transform 0.1s;
  }
  .bottom-btn:active{ transform:scale(0.96); }
  .bottom-btn .icon{
    background:var(--btn);
    width:48px;
    height:48px;
    border-radius:12px;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:24px;
    color:var(--btn-text);
  }
  .modal{
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.5);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:1000;
    opacity:0;
    pointer-events:none;
    transition:opacity 0.2s;
  }
  .modal.active{
    opacity:1;
    pointer-events:all;
  }
  .modal-content{
    background:var(--card);
    border-radius:24px;
    padding:24px;
    width:90%;
    max-width:400px;
    display:flex;
    flex-direction:column;
    gap:16px;
    transform:scale(0.9);
    transition:transform 0.2s;
  }
  .modal.active .modal-content{
    transform:scale(1);
  }
  .modal-list-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--pill);
    padding:12px 16px;
    border-radius:12px;
  }
  .delete-btn{
    background:var(--bg);
    color:var(--muted);
    border:1px solid transparent;
    width:32px;
    height:32px;
    border-radius:8px;
    font-size:18px;
    cursor:pointer;
  }
  .modal input{
    width:100%;
    padding:12px 16px;
    border-radius:12px;
    border:1px solid var(--pill-border);
    background:var(--pill);
    color:var(--text);
  }
  .modal-title{
    font-size:24px;
    font-weight:600;
    text-align:center;
    color:var(--text);
  }
  .modal-buttons{
    display:flex;
    gap:12px;
    justify-content:space-between;
    margin-top:8px;
  }
  .settings-options{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:12px;
  }
  .option-btn{
    background:var(--pill);
    color:var(--text);
    padding:12px;
    border-radius:12px;
    text-align:center;
    cursor:pointer;
    border:1px solid transparent;
    transition:border-color 0.2s;
  }
  .option-btn.active{
    border-color:var(--accent);
  }
  .log-container{
    max-height:150px;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    display:flex;
    flex-direction:column;
    gap:8px;
    color:var(--muted);
    font-size:14px;
  }
  .log-entry{
    background:var(--pill);
    padding:8px 12px;
    border-radius:8px;
  }
  .orange{
    color:var(--ring-15);
  }
</style>
</head>
<body id="root">

<div class="card-container">
  <div class="row" style="justify-content:space-between;">
    <a href="#" class="bottom-btn" id="customBtn">
      <span class="icon">+</span>
      <span>Custom</span>
    </a>
    <div class="pills" id="setRow"></div>
    <a href="#" class="bottom-btn" id="manageBtn">
      <span class="icon">⚙︎</span>
      <span>Manage</span>
    </a>
  </div>
  
  <div class="main-timer">
    <svg class="ring" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="47" stroke="var(--pill)" fill="none"/>
      <circle id="ring" cx="50" cy="50" r="47"/>
    </svg>
    <div class="timer-content">
      <h1 id="digits"></h1>
      <small id="status"></small>
    </div>
  </div>
  
  <div class="controls">
    <button class="btn btn-secondary btn-nudge" id="minusBtn">-</button>
    <button class="btn btn-primary" id="startBtn">Start</button>
    <button class="btn btn-secondary btn-nudge" id="plusBtn">+</button>
  </div>
  <div class="controls" id="secondaryControls">
    <button class="btn btn-secondary hidden" id="undoBtn">Undo</button>
    <button class="btn btn-secondary hidden" id="nextBtn">Next</button>
  </div>
</div>

<div class="row" id="presetRow" style="padding:16px 0;"></div>

<div class="card">
  <div class="row" style="justify-content:space-between; margin-bottom: 12px;">
    <span style="font-size:18px; font-weight:600;">Workout Log</span>
    <button class="btn btn-secondary" id="clearLog">Clear</button>
  </div>
  <div class="log-container" id="log"></div>
</div>

<div class="bottom-row">
  <a href="#" class="bottom-btn" id="settingsBtn">
    <span class="icon">◎</span>
    <span>Settings</span>
  </a>
</div>

<div class="modal" id="customModal">
  <div class="modal-content">
    <div class="modal-title">Custom Timer</div>
    <p style="text-align:center;color:var(--muted);font-size:14px;">(e.g., 1:30 for 90 seconds)</p>
    <input type="text" id="timeInput" placeholder="m:ss">
    <input type="number" id="setsInput" placeholder="Sets" value="3">
    <div class="modal-buttons">
      <button class="btn btn-secondary close-btn">Cancel</button>
      <button class="btn btn-primary" id="saveCustomBtn">Save</button>
    </div>
  </div>
</div>

<div class="modal" id="manageModal">
  <div class="modal-content">
    <div class="modal-title">Manage Presets</div>
    <div id="presetList"></div>
    <div class="modal-buttons">
      <button class="btn btn-primary close-btn" style="flex:1;">Done</button>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-title">Settings</div>
    <div>
      <h3 style="font-size:16px; font-weight:600; margin-bottom:8px;">Appearance</h3>
      <div class="settings-options">
        <button class="option-btn" id="lightMode">Light</button>
        <button class="option-btn" id="darkMode">Dark</button>
        <button class="option-btn" id="autoMode">Auto</button>
      </div>
    </div>
    <div>
      <h3 style="font-size:16px; font-weight:600; margin-bottom:8px;">Sounds & Haptics</h3>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span>Enabled</span>
        <label class="switch">
          <input type="checkbox" id="soundToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    <style>
      .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--pill-border); transition: .4s; border-radius: 28px; }
      .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: var(--accent); }
      input:checked + .slider:before { transform: translateX(20px); }
    </style>
    <div class="modal-buttons">
      <button class="btn btn-primary close-btn" style="flex:1;">Done</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- Utilities
  const $ = (sel, ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
  const pad = n => String(n).padStart(2,'0');
  const fmt12 = date => {
    let h = date.getHours();
    const m = date.getMinutes();
    const am = h < 12 ? 'AM':'PM';
    h = h%12; if(h===0) h=12;
    return h + ':' + pad(m) + ' ' + am;
  };
  // persistent
  const store = {
    get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };
  // ---------- Sounds (WebAudio for zero-pop beeps)
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioCtx();
  const haptics = 'vibrate' in navigator;
  const soundToggle = $('#soundToggle');
  // New audio unlock function
  function unlockAudio(){
      if (ctx.state === 'suspended') {
          ctx.resume();
      }
  }
  function playSound(){
    if(!soundToggle.checked) return Promise.resolve();
    return unlockAudio();
  }
  function playHaptics(){
    if(haptics && soundToggle.checked) navigator.vibrate(200);
  }
  function beep(f=880, dur=0.12, vol=0.18, type='sine', delay=0){
    const t0 = ctx.currentTime + delay;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = f;
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(vol, t0+0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    osc.connect(gain).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }
  function playShort(){ playSound().then(()=>beep(1200, 0.095, 0.14, 'sine')); playHaptics(); }
  function playEnd(){ playSound().then(()=>{ beep(880,0.12,0.16,'sine'); beep(660,0.12,0.16,'sine',0.16); }); playHaptics(); }
  // ---------- Model
  const ring = $('#ring');
  const digits = $('#digits');
  const statusEl = $('#status');
  const setRow = $('#setRow');
  const startBtn = $('#startBtn');
  const minusBtn = $('#minusBtn');
  const plusBtn = $('#plusBtn');
  const nextBtn = $('#nextBtn');
  const undoBtn = $('#undoBtn');
  const presetRow = $('#presetRow');
  const logEl = $('#log');
  const clearLogBtn = $('#clearLog');
  const customBtn = $('#customBtn');
  const manageBtn = $('#manageBtn');
  const settingsBtn = $('#settingsBtn');
  const root = document.getElementById('root');
  const customModal = $('#customModal');
  const manageModal = $('#manageModal');
  const settingsModal = $('#settingsModal');
  const modals = $$('.modal');
  const timeInput = $('#timeInput');
  const setsInput = $('#setsInput');
  const presetList = $('#presetList');
  const initialAppearance = store.get('appearance', 'auto');
  const osPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (initialAppearance === 'auto' && osPrefersDark) {
    applyAppearance('dark');
  } else {
    applyAppearance(initialAppearance);
  }
  const soundsEnabled = store.get('sounds', true);
  if(soundsEnabled) soundToggle.checked = true;
  else soundToggle.checked = false;
  soundToggle.addEventListener('change',()=>store.set('sounds', soundToggle.checked));
  function applyAppearance(mode){
    root.classList.remove('auto','light','dark');
    if(mode==='auto'){ root.classList.add('auto'); }
    else if(mode==='light'){ root.classList.add('light'); }
    else { root.classList.add('dark'); }
    $$('.option-btn').forEach(b => b.classList.remove('active'));
    $(`#${mode}Mode`).classList.add('active');
    store.set('appearance', mode);
  }
  const defaultPresets = [
    {seconds:60, sets:3},
    {seconds:60, sets:2},
    {seconds:90, sets:3},
    {seconds:120, sets:4},
    {seconds:45, sets:3},
    {seconds:75, sets:4},
  ];
  const presets = store.get('presets', defaultPresets);
  let presetIndex = store.get('lastPresetIndex', 0);
  if(presetIndex >= presets.length) presetIndex = 0;
  const state = {
    seconds: presets[presetIndex].seconds,
    totalSets: presets[presetIndex].sets,
    setIndex: 0,
    status:'idle',
    remaining: presets[presetIndex].seconds * 1000,
    raf: null,
    lastTs: null,
    justWarned:false,
    completing:false,
    workoutLetterIndex: store.get('workoutLetterIndex', 0),
    lastWholeSec: null,
  };
  function renderPresets(){
    presetRow.innerHTML = '';
    presets.forEach((p,i)=>{
      const b = document.createElement('button');
      b.className = 'preset-btn';
      b.innerHTML = `<span class="time-label">${minsSec(p.seconds)}</span><span class="sets-label">×${p.sets} Sets</span>`;
      if(i===presetIndex) b.classList.add('active');
      b.addEventListener('click', ()=> selectPreset(i,true));
      presetRow.appendChild(b);
    });
  }
  function selectPreset(i, fromUser=false){
    presetIndex = i;
    store.set('lastPresetIndex', i);
    const p = presets[i];
    state.seconds = p.seconds;
    state.totalSets = p.sets;
    state.setIndex = 0;
    resetTimer(true);
    if(fromUser) updateSetPills();
    renderPresets();
  }
  function updateSetPills(){
    setRow.innerHTML = '';
    for(let s=0;s<state.totalSets;s++){
      const pill = document.createElement('span');
      pill.className = 'pill' + (s===state.setIndex?' active':'') + (s<state.setIndex?' complete':'');
      pill.dataset.set = s;
      pill.textContent = 'Set ' + (s+1);
      pill.addEventListener('click',()=>{
        state.setIndex = s;
        resetTimer(true);
      });
      setRow.appendChild(pill);
    }
  }
  function resetTimer(hard=false){
    state.remaining = state.seconds*1000;
    state.status = 'idle';
    state.justWarned = false;
    state.completing = false;
    cancelAnimationFrame(state.raf);
    state.raf = null;
    state.lastTs = null;
    digits.textContent = formatTime(state.remaining);
    statusEl.innerHTML = 'Rest · idle';
    ring.style.stroke = getRingColor();
    drawRing(1);
    startBtn.textContent = 'Start';
    startBtn.classList.remove('orange');
    if(hard) updateSetPills();
    enableControls(false);
    state.lastWholeSec = null;
    digits.classList.remove('pulse');
  }
  function getRingColor(){
    if(state.remaining <= 15000) return getComputedStyle(document.documentElement).getPropertyValue('--ring-15') || '#ff8a22';
    return getComputedStyle(document.documentElement).getPropertyValue('--ring') || '#2e7cf7';
  }
  function formatTime(ms){
    ms = Math.max(0, ms|0);
    let s = Math.ceil(ms/1000);
    const m = Math.floor(s/60);
    s = s%60;
    return m + ':' + pad(s);
  }
  const CIRCUM = 2*Math.PI*47;
  function drawRing(progress){
    const offset = CIRCUM*(1-progress);
    ring.style.strokeDasharray = CIRCUM.toFixed(2);
    ring.style.strokeDashoffset = offset.toFixed(2);
  }
  function tick(ts){
    if(!state.lastTs) state.lastTs = ts;
    const delta = ts - state.lastTs;
    state.lastTs = ts;
    if(state.status==='running'){
      state.remaining -= delta;
      // Pulse for the last 3 seconds
      const wholeSec = Math.ceil(state.remaining / 1000);
      if (wholeSec <= 3 && wholeSec >= 1 && wholeSec !== state.lastWholeSec) {
        digits.classList.remove('pulse');
        // A little trick to restart the animation
        void digits.offsetWidth;
        digits.classList.add('pulse');
      }
      state.lastWholeSec = wholeSec;
      if(state.remaining <= 15000 && !state.justWarned){
        state.justWarned = true;
        ring.style.stroke = getRingColor();
        playShort();
      }
      if(state.remaining <= 0){
        completeSet();
        return;
      }
      digits.textContent = formatTime(state.remaining);
      ring.style.stroke = getRingColor();
      drawRing(state.remaining/(state.seconds*1000));
      statusEl.innerHTML = (state.setIndex+1 < state.totalSets) ? `Up next: <strong>Set ${state.setIndex+2}</strong>` : `Rest: <strong class="orange">Last set</strong>`;
      state.raf = requestAnimationFrame(tick);
    }
  }
  function completeSet(){
    if(state.completing) return;
    state.completing = true;
    state.status = 'finished';
    state.remaining = 0;
    drawRing(0);
    digits.textContent = '0:00';
    playEnd();
    digits.classList.remove('pulse');
    if(state.setIndex < state.totalSets-1){
      state.setIndex++;
      updateSetPills();
      resetTimer(true);
      setTimeout(()=>{ state.completing=false; }, 200);
    }else{
      const finalPill = $(`[data-set="${state.setIndex}"]`);
      if(finalPill) finalPill.classList.add('complete');
      startBtn.textContent = 'Finish workout';
      startBtn.classList.add('orange');
      enableControls(false);
      setTimeout(()=>{ state.completing=false; }, 200);
    }
  }
  function start(){
    if(state.status==='running') return;
    startBtn.textContent = 'Pause';
    startBtn.classList.remove('orange');
    state.status='running';
    enableControls(true);
    state.lastTs=null;
    ring.style.stroke = getRingColor();
    state.raf = requestAnimationFrame(tick);
  }
  function pause(){
    state.status='paused';
    startBtn.textContent='Resume';
    enableControls(true);
    digits.classList.remove('pulse');
  }
  function toggleStart(){
    if(state.status==='idle' || state.status==='paused'){
      start();
    }else if(state.status==='running'){
      pause();
    }else if(state.status==='finished'){
      logWorkout();
      state.setIndex = 0;
      updateSetPills();
      resetTimer();
    }
  }
  function next(){
    if(state.setIndex < state.totalSets-1){
      state.setIndex++;
      updateSetPills();
      resetTimer();
    }
  }
  function undo(){
    if(state.setIndex>0){
      state.setIndex--;
      updateSetPills();
      resetTimer();
    }
  }
  function nudger(delta){
    const cap = state.seconds*1000;
    state.remaining = Math.min(cap, Math.max(0, (state.remaining|0)+delta));
    digits.textContent = formatTime(state.remaining);
    ring.style.stroke = getRingColor();
    drawRing(state.remaining/cap);
  }
  function enableControls(on){
    const mainControls = $('#secondaryControls');
    if(on){
      minusBtn.textContent = '-15s';
      plusBtn.textContent = '+15s';
      mainControls.classList.remove('hidden');
    } else {
      minusBtn.textContent = '-';
      plusBtn.textContent = '+';
      mainControls.classList.add('hidden');
    }
  }
  function todaysKey(){
    const d = new Date();
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
  }
  function loadLog(){
    const key = 'log-'+todaysKey();
    return store.get(key, []);
  }
  function saveLog(items){
    const key = 'log-'+todaysKey();
    store.set(key, items);
  }
  function renderLog(){
    const items = loadLog();
    if(!items.length){ logEl.innerHTML='No sets yet'; return; }
    logEl.innerHTML = items.map(i=>`<div class="log-entry">Workout ${i.letter}: ${minsSec(presets.find(p=>p.seconds===state.seconds && p.sets===state.totalSets)?.seconds || state.seconds)} ×${state.totalSets} — ${i.time}</div>`).join('');
  }
  function logWorkout(){
    const items = loadLog();
    const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const letter = letters[state.workoutLetterIndex % letters.length];
    state.workoutLetterIndex++;
    store.set('workoutLetterIndex', state.workoutLetterIndex);
    const p = presets[presetIndex];
    items.push({letter, seconds:p.seconds, sets:p.sets, time: fmt12(new Date())});
    saveLog(items);
    renderLog();
  }
  function minsSec(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return m + ':' + pad(s);
  }
  // ---------- Modal Logic
  function openModal(modal){
    modals.forEach(m => m.classList.remove('active'));
    modal.classList.add('active');
  }
  function closeModal(modal){
    modal.classList.remove('active');
  }
  // Custom Preset Modal
  customBtn.addEventListener('click', ()=>{
    timeInput.value = '';
    setsInput.value = '3';
    openModal(customModal);
  });
  $('#saveCustomBtn').addEventListener('click', ()=>{
    const v = timeInput.value;
    const m = v.match(/^\s*(\d+):(\d{1,2})\s*$/);
    const sets = parseInt(setsInput.value, 10);
    if(!m || isNaN(sets) || sets <= 0) {
      const msgBox = document.createElement('div');
      msgBox.className = 'modal-content';
      msgBox.innerHTML = '<p style="text-align:center;">Invalid format. Please use "m:ss" for time and a number for sets.</p><div class="modal-buttons"><button class="btn btn-primary close-btn">OK</button></div>';
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.appendChild(msgBox);
      document.body.appendChild(modal);
      modal.querySelector('.close-btn').addEventListener('click', () => { modal.remove(); });
      return;
    }
    const seconds = (+m[1])*60 + (+m[2]);
    presets.unshift({seconds, sets});
    store.set('presets', presets);
    renderPresets();
    selectPreset(0,true);
    closeModal(customModal);
  });
  // Manage Presets Modal
  manageBtn.addEventListener('click', ()=>{
    presetList.innerHTML = presets.map((p,i)=>`
      <div class="modal-list-item">
        <span>${minsSec(p.seconds)} ×${p.sets}</span>
        <button class="delete-btn" data-index="${i}">&times;</button>
      </div>
    `).join('');
    openModal(manageModal);
  });
  presetList.addEventListener('click', (e)=>{
    if(e.target.classList.contains('delete-btn')){
      const i = parseInt(e.target.dataset.index, 10);
      presets.splice(i,1);
      store.set('presets', presets);
      presetIndex = 0;
      renderPresets();
      selectPreset(0,true);
      // Re-render the list
      presetList.innerHTML = presets.map((p,i)=>`
        <div class="modal-list-item">
          <span>${minsSec(p.seconds)} ×${p.sets}</span>
          <button class="delete-btn" data-index="${i}">&times;</button>
      </div>
      `).join('');
    }
  });
  // Settings Modal
  settingsBtn.addEventListener('click', ()=>{
    const currentAppearance = store.get('appearance', 'auto');
    $$('.option-btn').forEach(b => b.classList.remove('active'));
    $(`#${currentAppearance}Mode`).classList.add('active');
    openModal(settingsModal);
  });
  $('#lightMode').addEventListener('click', ()=> applyAppearance('light'));
  $('#darkMode').addEventListener('click', ()=> applyAppearance('dark'));
  $('#autoMode').addEventListener('click', ()=> applyAppearance('auto'));
  // Universal close button for modals
  $$('.close-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      closeModal(e.target.closest('.modal'));
    });
  });
  startBtn.addEventListener('click', toggleStart);
  nextBtn.addEventListener('click', next);
  undoBtn.addEventListener('click', undo);
  minusBtn.addEventListener('click', ()=> nudger(-15000));
  plusBtn.addEventListener('click', ()=> nudger(15000));
  clearLogBtn.addEventListener('click', ()=>{
    saveLog([]); renderLog();
    store.set('workoutLetterIndex', 0);
    state.workoutLetterIndex = 0;
  });
  renderPresets();
  selectPreset(presetIndex);
  renderLog();
  setInterval(()=>{
    if(!isFinite(state.remaining)) resetTimer();
    if(!digits.textContent || digits.textContent.includes('NaN')) digits.textContent = formatTime(state.remaining);
  },500);
})();</script>

<script>
// Register service worker for offline/installability
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed', err));
  });
}
// Keep screen awake during use (iOS 16+ supports Screen Wake Lock)
let screenWakeLock = null;
async function requestWakeLock() {
  try {
    screenWakeLock = await navigator.wakeLock.request('screen');
    screenWakeLock.addEventListener('release', () => { screenWakeLock = null; });
  } catch (e) { console.log('WakeLock unavailable', e); }
}
// Acquire on first tap; re-acquire when returning to app
window.addEventListener('pointerdown', requestWakeLock, {once: true});
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && !screenWakeLock && 'wakeLock' in navigator) {
    requestWakeLock();
  }
});
</script>
</body>
</html>
