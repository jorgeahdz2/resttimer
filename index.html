<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Workout Rest Timer</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" href="resttimer-roundcap-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
<link rel="icon" href="resttimer-roundcap-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
<style>
  :root{
    --bg: #0f1419;
    --card: #141a21;
    --text: #eaf0f6;
    --muted:#9fb0c1;
    --ring:#2e7cf7;
    --ring-15:#ff8a22;
    --accent:#2e7cf7;
    --accent-press:#1f66d6;
    --btn:#1a2230;
    --btn-text:#eaf0f6;
    --pill:#10161d;
    --pill-border:#243040;
    --shadow: 0 4px 12px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.1);
    --warn-fill: rgba(255,138,34,.15);
  }
  .light{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#0b1722;
    --muted:#6b7c8d;
    --ring:#1f6eff;
    --ring-15:#ff7a1a;
    --accent:#1f6eff;
    --accent-press:#0d50c9;
    --btn:#f3f5f8;
    --btn-text:#0b1722;
    --pill:#f6f8fb;
    --pill-border:#e4e9ef;
    --shadow: 0 4px 12px rgba(20,30,40,.08), 0 1px 2px rgba(20,30,40,.05);
    --warn-fill: rgba(255,122,26,.15);
  }
  @media (prefers-color-scheme: light){
    :root.auto{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0b1722;
      --muted:#6b7c8d;
      --ring:#1f6eff;
      --ring-15:#ff7a1a;
      --accent:#1f6eff;
      --accent-press:#0d50c9;
      --btn:#f3f5f8;
      --btn-text:#0b1722;
      --pill:#f6f8fb;
      --pill-border:#e4e9ef;
      --shadow: 0 4px 12px rgba(20,30,40,.08), 0 1px 2px rgba(20,30,40,.05);
      --warn-fill: rgba(255,122,26,.15);
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 500px at 50% -200px, rgba(255,255,255,.06), transparent 60%) , var(--bg);
    color:var(--text);
    font: 16px/1.45 system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  header{display:flex;justify-content:center;align-items:center;margin:12px 0 20px}
  .app-title{
    font-weight:800;
    letter-spacing:.2px;
    font-size: clamp(22px, 3.4vw, 32px);
    text-shadow: 0 2px 16px rgba(0,0,0,.25);
  }
  .cards{display:flex; flex-direction:column; gap:12px}
  .card{
    background:var(--card);
    border-radius:22px;
    box-shadow: var(--shadow);
    padding:18px 18px 22px;
  }
  .main{display:flex;flex-direction:column; align-items:center}
  .ring-wrap{width:min(60vw, 420px); max-width:420px; aspect-ratio:1/1; position:relative; margin-bottom: 56px;}
  svg{width:100%;height:100%;display:block}
  .ring-bg{stroke: var(--pill-border); opacity:1}
  .ring{stroke:var(--ring); transition: stroke .2s ease}
  .time{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    pointer-events:none; text-align:center;
  }
  .time .digits{
    font-weight:800;
    letter-spacing: .5px;
    font-size:clamp(80px, 12vw, 120px);
    text-shadow: 0 2px 16px rgba(0,0,0,.25);
  }
  .status{
    margin-top:6px;
    color:var(--muted);
    font-weight:600;
    letter-spacing:.2px;
  }
  .status strong{
    font-weight: 800;
  }
  .status strong.orange{
    color: var(--ring-15);
  }

  .row{
    display:flex; 
    gap:12px; 
    flex-wrap:nowrap; 
    justify-content:center; 
    align-items:center; 
    width:100%;
  }

  .controls-row {
    display:flex; 
    gap:12px; 
    flex-wrap:nowrap; 
    justify-content:center; 
    align-items:center; 
    width: 100%;
    padding: 0 8px; /* Buffer margin */
  }

  .btn{
    background:var(--btn);
    color:var(--btn-text);
    padding:14px 18px;
    border-radius:14px;
    border:1px solid transparent;
    box-shadow: var(--shadow);
    font-weight:800;
    letter-spacing:.3px;
    cursor:pointer; user-select:none;
    transition: transform .03s ease, background .15s ease, border-color .15s ease, color .15s ease;
    white-space: nowrap;
    touch-action: manipulation;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .btn:active{transform: scale(0.98);}
  .btn-primary{
    background:var(--accent); color:white;
    padding:14px 18px; font-size:16px;
    text-align: center;
    flex-grow: 1;
    flex-shrink: 1;
    flex-basis: 0;
    min-width: 100px;
    max-width: 220px;
  }
  .btn-primary:active{background:var(--accent-press)}
  .btn.orange{
    background: var(--ring-15);
    color: white;
  }
  .btn.orange:active{
    background: #e67a1e;
  }
  .btn-ghost, .btn-subtle {
    flex-shrink: 0;
  }
  .btn-ghost { 
    min-width: 100px;
  }
  .btn-ghost{background:var(--pill); border-color:var(--pill-border)}
  .btn-subtle{background:none; border-color:var(--pill-border); color:var(--text); box-shadow:none; padding:13px 18px}
  .btn-subtle:active{background:var(--pill); transform: none}

  .btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  .pill{padding:7px 14px; border-radius:999px; background:var(--pill); color:var(--text); border:1px solid var(--pill-border); font-weight:700; font-size:14px; box-shadow:var(--shadow);}
  .pill.active{outline:3px solid rgba(47,128,255,.35)}
  .pill.complete{
    background:var(--warn-fill);
    color: var(--ring-15);
    border-color: var(--ring-15);
  }
  .subtle{color:var(--muted); font-weight:700}
  .subtle strong{color:var(--text)}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); align-items:center}
  .footer-row{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center}
  .logbox{padding:12px 14px; background:var(--pill); border:1px solid var(--pill-border); border-radius:14px; flex:1; line-height:1.9; margin-top:20px; box-shadow:var(--shadow);}
  .log-entry{padding:10px 2px; border-top:1px solid var(--pill-border); margin-top:2px}
  .log-entry:first-child{border-top:0; margin-top:0}
  .small{font-size:13px}
  .hidden{display:none !important}
  .center{display:flex; align-items:center; justify-content:center}

  .preset-btn {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 12px 0;
    background: var(--btn);
    color: var(--btn-text);
    border-radius: 14px;
    border: 1px solid var(--pill-border);
    box-shadow: none;
    cursor: pointer;
    user-select: none;
    transition: transform .03s ease, background .15s ease, border-color .15s ease;
    text-align: center;
  }
  .preset-btn:active{transform: scale(0.98);}

  .preset-btn.active{
    background: rgba(47,128,255,.1);
    color: var(--accent);
    border-color: var(--accent);
    box-shadow: none;
  }
  .preset-btn.active:active{background: rgba(47,128,255,.15);}
  .preset-btn .time-label {
    font-weight: 800;
    letter-spacing: .3px;
    font-size: 16px;
  }
  .preset-btn .sets-label {
    color: var(--muted);
    font-weight: 700;
    font-size: 14px;
    line-height: 1.2;
    margin-top: 2px;
    letter-spacing: .2px;
  }
  .preset-btn.active .sets-label{
    color: var(--accent);
  }

  #log, .pill, .btn-ghost{
      box-shadow: none;
  }
  .pill, .btn-ghost{
    background: var(--btn);
    border-color: var(--pill-border);
  }
  #log{
    background: var(--pill);
    border-color: var(--pill-border);
  }
  .pill.active{
    outline:3px solid rgba(47,128,255,.35);
  }

  .log-entry{
    font-size: 14px;
    color: var(--text);
  }
  .log-entry strong{
    color: var(--text);
  }
  .logbox {
    box-shadow: var(--shadow);
  }
  .footer-row .btn-ghost{
    box-shadow: none;
  }

  .footer-links{
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 16px;
  }
  .footer-links button{
    font-weight: 700;
    font-size: 14px;
    padding: 7px 14px;
    border-radius: 999px;
    background: var(--btn);
    color: var(--muted);
    border: 1px solid var(--pill-border);
    cursor: pointer;
    transition: background .15s ease;
  }
  .footer-links button:active{
    background: var(--pill-border);
  }

  .modal{
    position:fixed; inset:0; z-index:100;
    background:rgba(0,0,0,.8);
    backdrop-filter: blur(8px);
    display:flex; align-items:center; justify-content:center;
    opacity:0; pointer-events:none;
    transition: opacity .15s ease;
  }
  .modal.active{
    opacity:1; pointer-events:auto;
  }
  .modal-content{
    background:var(--card);
    border-radius:24px;
    width:min(90vw, 420px);
    padding:24px;
    box-shadow: var(--shadow);
    transform: translateY(16px);
    transition: transform .25s ease;
    max-width: 420px;
    margin: 12px;
  }
  .modal.active .modal-content{
    transform: translateY(0);
  }
  .modal-title{
    font-size:22px;
    font-weight:800;
    text-align:center;
    margin-bottom:20px;
    letter-spacing: .2px;
  }
  .modal-row{display:flex; gap:12px; margin-top:16px}
  .modal-row .btn{flex:1}
  .modal-input{
    background:var(--pill);
    border:1px solid var(--pill-border);
    color:var(--text);
    padding:12px 18px;
    border-radius:14px;
    width:100%;
    font-size:16px;
    font-family: inherit;
  }
  .modal-label{font-weight:700; margin-bottom:6px; color:var(--muted)}
  .modal-list{
    max-height: 240px; overflow-y:auto; margin:-12px; padding:12px;
    border-radius:12px;
    background:rgba(0,0,0,.04);
  }
  .modal-list-item{
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--card);
    border-radius:10px;
  }
  .modal-list-item+.modal-list-item{margin-top:8px}
  .modal-list-item span{font-weight:600}
  .modal-list-item .delete-btn{
    background:none;
    border:none;
    font-size:20px;
    color:#ff6666;
    padding:4px 8px;
    cursor:pointer;
  }
  .setting-row{
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 0; border-top:1px solid var(--pill-border);
    font-weight:600;
    color:var(--text);
  }
  .setting-row:first-child{border-top:none}

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
  }
  .toggle-switch input { display:none; }
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--btn);
    border: 1px solid var(--pill-border);
    transition: .4s;
    border-radius: 26px;
  }
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 2px;
    background-color: var(--muted);
    transition: .4s;
    border-radius: 50%;
  }
  .toggle-switch input:checked + .toggle-slider {
    background-color: var(--accent);
    border-color: var(--accent);
  }
  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
    background-color: white;
  }
  
  /* Summary Modal Styles */
  .summary-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
    margin: 24px 0;
  }
  .summary-stats div {
    display: flex;
    flex-direction: column;
  }
  .summary-stats .stat-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--text);
  }
  .summary-stats .stat-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    margin-top: 4px;
  }

  @keyframes timepulse {
    0% { transform: scale(1); }
    40% { transform: scale(1.025); }
    100% { transform: scale(1); }
  }
  .time .digits.pulse {
    animation: timepulse .28s ease-out;
  }

  @media (max-width: 560px){
    .controls-row{gap:8px} 
    .btn{padding:11px 14px}
    .btn-subtle{padding:10px 14px}
    .footer-links{
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
    }
  }
  #setRow{
    margin-top: 40px;
  }
</style>
</head>
<body class="auto" id="root">
  <div class="wrap">
    <header><div class="app-title">Workout Rest Timer</div></header>

    <section class="cards">

      <div class="card main">
        <div class="ring-wrap" id="ringWrap">
          <svg viewBox="0 0 100 100">
            <g transform="rotate(-90 50 50)">
              <circle class="ring-bg" cx="50" cy="50" r="47" stroke-width="6" fill="none"/>
              <circle id="ring" class="ring" cx="50" cy="50" r="47" stroke-width="6" fill="none"
                stroke-linecap="round" stroke-dasharray="295.31" stroke-dashoffset="0"/>
            </g>
          </svg>
          <div class="time">
            <div id="digits" class="digits">1:00</div>
            <div id="status" class="status">Rest · idle</div>
          </div>
        </div>

        <div class="controls-row">
          <button id="backBtn" class="btn btn-ghost">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
              Back
          </button>
          <button id="minusBtn" class="btn btn-subtle">–15s</button>
          <button id="startBtn" class="btn btn-primary">Start</button>
          <button id="plusBtn" class="btn btn-subtle">+15s</button>
          <button id="skipBtn" class="btn btn-ghost">
            Skip 
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
          </button>
        </div>

        <div class="row" id="setRow">
          </div>
      </div>

      <div class="card">
        <div class="grid" id="presetRow"></div>
      </div>

      <div class="card">
        <div class="footer-row">
          <div class="pill">Logs reset daily</div>
          <button class="btn btn-ghost" id="clearLog">Clear</button>
        </div>
        <div id="log" class="logbox small">No sets yet</div>
      </div>

      <div class="card">
        <div class="footer-links">
          <button id="customBtn" class="pill">Custom</button>
          <button id="manageBtn" class="pill">Manage</button>
          <button id="settingsBtn" class="pill">Settings</button>
        </div>
      </div>

    </section>
  </div>

  <div id="customModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Add Custom Preset</div>
      <label class="modal-label" for="timeInput">Time (m:ss)</label>
      <input type="text" id="timeInput" class="modal-input" placeholder="e.g., 1:30">
      <label class="modal-label" style="margin-top:12px" for="setsInput">Sets</label>
      <input type="number" id="setsInput" class="modal-input" value="3" min="1">
      <div class="modal-row">
        <button class="btn btn-ghost close-btn">Cancel</button>
        <button id="saveCustomBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="manageModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Manage Presets</div>
      <div id="presetList" class="modal-list"></div>
      <div class="modal-row">
        <button class="btn btn-primary close-btn">Close</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Settings</div>
      <div class="setting-row">
        <span>Sounds & Haptics</span>
        <label class="toggle-switch">
          <input type="checkbox" id="soundToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <span>Notifications</span>
        <label class="toggle-switch">
          <input type="checkbox" id="notificationToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <span>App Theme</span>
        <div class="modal-row" style="margin:0">
          <button class="btn btn-ghost" id="lightMode">Light</button>
          <button class="btn btn-ghost" id="darkMode">Dark</button>
          <button class="btn btn-ghost" id="autoMode">Auto</button>
        </div>
      </div>
      <div class="modal-row">
        <button class="btn btn-primary close-btn">Close</button>
      </div>
    </div>
  </div>
  
  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Workout Complete!</div>
      <div class="summary-stats">
        <div>
          <span id="summarySets" class="stat-value">3/3</span>
          <span class="stat-label">Sets</span>
        </div>
        <div>
          <span id="summaryTime" class="stat-value">4:30</span>
          <span class="stat-label">Total Rest</span>
        </div>
      </div>
      <div class="modal-row">
        <button id="summaryDoneBtn" class="btn btn-primary">Done</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- Utilities
  const $ = (sel, ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
  const pad = n => String(n).padStart(2,'0');
  const fmt12 = date => {
    let h = date.getHours();
    const m = date.getMinutes();
    const am = h < 12 ? 'AM':'PM';
    h = h%12; if(h===0) h=12;
    return h + ':' + pad(m) + ' ' + am;
  };

  const store = {
    get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };

  // ---------- Sounds & Haptics
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx;
  const haptics = 'vibrate' in navigator;
  const soundToggle = $('#soundToggle');
  const notificationToggle = $('#notificationToggle');

  function initAudio() {
    if (!ctx) ctx = new AudioCtx();
    return ctx.resume();
  }
  document.body.addEventListener('click', initAudio, { once: true });

  function playSound(){
    if(!soundToggle.checked || !ctx) return Promise.resolve();
    return ctx.resume();
  }
  function playHaptics(pattern = 200){
    if(haptics && soundToggle.checked) navigator.vibrate(pattern);
  }
  function beep(f=880, dur=0.12, vol=0.18, type='sine', delay=0){
    if (!ctx) return;
    const t0 = ctx.currentTime + delay;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = f;
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(vol, t0+0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    osc.connect(gain).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }
  function playShort(){ playSound().then(()=>beep(1200, 0.095, 0.14, 'sine')); playHaptics(50); }
  function playEnd(){ playSound().then(()=>{ beep(880,0.12,0.16,'sine'); beep(660,0.12,0.16,'sine',0.16); }); playHaptics([200, 100, 200]); }

  // ---------- DOM Elements
  const ring = $('#ring');
  const digits = $('#digits');
  const statusEl = $('#status');
  const setRow = $('#setRow');
  const startBtn = $('#startBtn');
  const minusBtn = $('#minusBtn');
  const plusBtn = $('#plusBtn');
  const skipBtn = $('#skipBtn');
  const backBtn = $('#backBtn');
  const presetRow = $('#presetRow');
  const logEl = $('#log');
  const root = $('#root');

  // ---------- App State & Data
  let state = {
    seconds: 60,
    totalSets: 3,
    setIndex: 0,
    status:'idle', // idle, running, paused, finished
    remaining: 60000,
    raf: null,
    lastTs: null,
    justWarned: false,
    completing: false,
    workoutLetterIndex: store.get('workoutLetterIndex', 0),
    lastWholeSec: null,
    actualRestTime: 0,
    nudgeInterval: null,
    workoutLogData: [],
  };
  
  let wakeLock = null;
  const requestWakeLock = async () => {
    if ('wakeLock' in navigator) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
      } catch (err) {
        console.error(`${err.name}, ${err.message}`);
      }
    }
  };
  const releaseWakeLock = () => {
    if (wakeLock) {
      wakeLock.release()
        .then(() => {
          wakeLock = null;
        })
        .catch(console.error);
    }
  };

  const appearance = store.get('appearance','auto');
  applyAppearance(appearance);
  soundToggle.checked = store.get('sounds', true);
  notificationToggle.checked = store.get('notifications', true);
  
  const defaultPresets = [
    {id: 'p1', seconds:60, sets:3}, {id: 'p2', seconds:60, sets:2},
    {id: 'p3', seconds:90, sets:3}, {id: 'p4', seconds:120, sets:4},
    {id: 'p5', seconds:45, sets:3}, {id: 'p6', seconds:75, sets:4},
  ];
  let presets = store.get('presets', defaultPresets.map(p => ({...p, id: p.id || crypto.randomUUID() })));
  let presetIndex = store.get('lastPresetIndex', 0);
  if(presetIndex >= presets.length) presetIndex = 0;
  
  // ---------- Core Functions
  function renderPresets(){
    presetRow.innerHTML = presets.map((p,i) => `
      <button class="preset-btn ${i === presetIndex ? 'active' : ''}" data-index="${i}">
        <span class="time-label">${minsSec(p.seconds)}</span>
        <span class="sets-label">×${p.sets} Sets</span>
      </button>
    `).join('');
  }

  function selectPreset(i, fromUser=false){
    presetIndex = i;
    store.set('lastPresetIndex', i);
    const p = presets[i];
    state.seconds = p.seconds;
    state.totalSets = p.sets;
    state.setIndex = 0;
    resetTimer(true); 
    if(fromUser) updateSetPills();
    renderPresets();
  }

  function updateSetPills(){
    setRow.innerHTML = Array.from({length: state.totalSets}, (_, s) => `
      <span class="pill ${s === state.setIndex ? 'active' : ''} ${s < state.setIndex ? 'complete' : ''}" data-set="${s}">
        Set ${s + 1}
      </span>
    `).join('');
  }
  
  function updateUIFromState() {
      digits.textContent = formatTime(state.remaining);
      drawRing(state.remaining / (state.seconds * 1000));
      updateSetPills();
      updateControls();
  }

  function resetTimer(hard=false){
    if (hard) {
      state.workoutLogData = [];
    }
    state.remaining = state.seconds * 1000;
    state.status = 'idle';
    state.justWarned = false;
    state.completing = false;
    state.actualRestTime = 0;
    cancelAnimationFrame(state.raf);
    state.raf = null;
    state.lastTs = null;
    digits.textContent = formatTime(state.remaining);
    ring.style.stroke = getRingColor();
    drawRing(1);
    if(hard) updateSetPills();
    updateControls();
    state.lastWholeSec = null;
    digits.classList.remove('pulse');
    releaseWakeLock();
  }

  function formatTime(ms){
    ms = Math.max(0, ms|0);
    let s = Math.ceil(ms/1000);
    const m = Math.floor(s/60);
    s %= 60;
    return `${m}:${pad(s)}`;
  }

  function minsSec(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${pad(s)}`;
  }

  const CIRCUM = 2 * Math.PI * 47;
  function drawRing(progress){
    const offset = CIRCUM * (1 - progress);
    ring.style.strokeDasharray = CIRCUM.toFixed(2);
    ring.style.strokeDashoffset = offset.toFixed(2);
  }

  function tick(ts){
    if(!state.lastTs) state.lastTs = ts;
    const delta = ts - state.lastTs;
    state.lastTs = ts;

    if(state.status === 'running'){
      state.remaining -= delta;
      state.actualRestTime += delta;

      const wholeSec = Math.ceil(state.remaining / 1000);
      if (wholeSec <= 3 && wholeSec >= 1 && wholeSec !== state.lastWholeSec) {
        digits.classList.remove('pulse');
        void digits.offsetWidth;
        digits.classList.add('pulse');
      }
      state.lastWholeSec = wholeSec;

      if(state.remaining <= 15000 && !state.justWarned){
        state.justWarned = true;
        playShort();
      }

      if(state.remaining <= 0){
        completeSet();
        return;
      }

      digits.textContent = formatTime(state.remaining);
      ring.style.stroke = getRingColor();
      drawRing(state.remaining / (state.seconds * 1000));
    }
    state.raf = requestAnimationFrame(tick);
  }

  function completeSet(){
    if(state.completing) return;
    state.completing = true;
    releaseWakeLock();
    state.status = 'idle';
    state.remaining = 0;
    drawRing(0);
    digits.textContent = '0:00';
    playEnd();

    if (state.actualRestTime > 1000) {
      state.workoutLogData.push({ actualTime: state.actualRestTime });
    }
    digits.classList.remove('pulse');

    let notifTitle = "Rest Complete!";
    let notifBody = (state.setIndex < state.totalSets - 1)
      ? `Set ${state.setIndex + 1} done. Get ready for set ${state.setIndex + 2}!`
      : `Great job! You completed all ${state.totalSets} sets.`;
    if(state.setIndex >= state.totalSets - 1) notifTitle = "Workout Finished!";

    showNotification(notifTitle, { body: notifBody, tag: 'workout-timer' });

    if(state.setIndex < state.totalSets - 1){
      state.setIndex++;
      updateSetPills();
      resetTimer();
    } else {
      state.status = 'finished';
      const finalPill = $(`[data-set="${state.setIndex}"]`);
      if(finalPill) finalPill.classList.add('complete');
      updateControls();
      releaseWakeLock();
    }
    setTimeout(() => { state.completing = false; }, 200);
  }

  function updateControls() {
    const isRunning = state.status === 'running';
    const isPaused = state.status === 'paused';
    const isFinished = state.status === 'finished';
    const isFirstSet = state.setIndex === 0;
    const isLastSet = state.setIndex === state.totalSets - 1;

    const backBtnText = backBtn.childNodes[1];
    const skipBtnText = skipBtn.childNodes[0]; 
    const timerActive = isRunning || isPaused;
    
    if (backBtnText && backBtnText.nodeType === 3) {
      backBtnText.nodeValue = timerActive ? ' ' : ' Back';
    }
    if (skipBtnText && skipBtnText.nodeType === 3) {
      if (isLastSet && timerActive) {
          skipBtnText.nodeValue = 'Finish ';
      } else {
          skipBtnText.nodeValue = timerActive ? ' ' : ' Skip ';
      }
    }
    
    if (isFinished) {
      startBtn.textContent = 'Finish';
      startBtn.classList.add('orange');
    } else if (isRunning) {
      startBtn.textContent = 'Pause';
      startBtn.classList.remove('orange');
    } else if (isPaused) {
      startBtn.textContent = 'Resume';
      startBtn.classList.remove('orange');
    } else { // idle
      startBtn.textContent = 'Start';
      startBtn.classList.remove('orange');
    }

    minusBtn.classList.toggle('hidden', !(isRunning || isPaused));
    plusBtn.classList.toggle('hidden', !(isRunning || isPaused));
    backBtn.disabled = isFirstSet && !isFinished;

    if (isRunning) {
        statusEl.innerHTML = (isLastSet) ? `Rest: <strong class="orange">Last set</strong>` : `Up next: <strong>Set ${state.setIndex + 2}</strong>`;
    } else {
        statusEl.innerHTML = 'Rest · ' + state.status;
    }
  }

  function toggleStart(){
    if (state.status === 'idle' || state.status === 'paused') {
        start();
    } else if (state.status === 'running') {
        pause();
    } else if (state.status === 'finished') {
        logFinishedWorkout();
        showSummaryModal();
    }
  }

  function start(){
    if(state.status === 'running') return;
    initAudio();
    requestNotificationPermission();
    requestWakeLock();
    state.status='running';
    state.lastTs=null;
    if (state.raf) cancelAnimationFrame(state.raf);
    state.raf = requestAnimationFrame(tick);
    updateControls();
  }

  function pause(){
    releaseWakeLock();
    state.status='paused';
    digits.classList.remove('pulse');
    cancelAnimationFrame(state.raf);
    state.raf = null;
    updateControls();
  }

  function skip(){
    if (state.actualRestTime > 1000) {
      state.workoutLogData.push({ actualTime: state.actualRestTime });
    }
    if (state.setIndex < state.totalSets - 1) {
      state.setIndex++;
      updateSetPills();
      resetTimer();
    } else {
      state.status = 'finished';
      state.remaining = 0;
      drawRing(0);
      digits.textContent = '0:00';
      const finalPill = $(`[data-set="${state.setIndex}"]`);
      if(finalPill) finalPill.classList.add('complete');
      updateControls();
      releaseWakeLock();
    }
  }

  function back(){
    if (state.status === 'finished') {
        state.status = 'idle';
        updateSetPills();
    } else if(state.setIndex > 0){
        state.setIndex--;
        updateSetPills();
    }
    resetTimer();
  }

  function nudger(delta){
    state.remaining = Math.max(0, (state.remaining|0) + delta);
    if(state.status !== 'running') {
        state.seconds = Math.round(state.remaining / 1000);
    }
    digits.textContent = formatTime(state.remaining);
    ring.style.stroke = getRingColor();
    drawRing(state.remaining / (state.seconds * 1000));
  }

  function getRingColor(){
    if(state.remaining <= 15000) return getComputedStyle(document.documentElement).getPropertyValue('--ring-15') || '#ff8a22';
    return getComputedStyle(document.documentElement).getPropertyValue('--ring') || '#2e7cf7';
  }

  // ---------- Logging
  function todaysKey(){
    const d = new Date();
    return `log-${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function loadLog(){ return store.get(todaysKey(), []); }
  function saveLog(items){ store.set(todaysKey(), items); }
  function renderLog(){
    const items = loadLog();
    logEl.innerHTML = !items.length ? 'No sets yet'
      : items.map(i => `<div class="log-entry">Workout ${i.letter}: ${i.setsCompleted}/${i.targetSets} sets, rest ${minsSec(Math.round(i.totalActualTime/1000))} — ${i.time}</div>`).join('');
  }
  function logFinishedWorkout() {
    if (state.workoutLogData.length < 1) return;
    const items = loadLog();
    const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const letter = letters[state.workoutLetterIndex % letters.length];
    const p = presets[presetIndex];
    const totalActualTime = state.workoutLogData.reduce((sum, set) => sum + set.actualTime, 0);
    const setsCompleted = state.workoutLogData.length;
    items.push({
      letter,
      targetSets: p.sets,
      setsCompleted: setsCompleted,
      time: fmt12(new Date()),
      totalActualTime: totalActualTime
    });
    saveLog(items);
    renderLog();
    state.workoutLetterIndex++;
    store.set('workoutLetterIndex', state.workoutLetterIndex);
  }
  
  // ---------- State Persistence
  function saveState() {
    const stateToSave = {
      setIndex: state.setIndex,
      status: state.status,
      remaining: state.remaining,
      workoutLogData: state.workoutLogData,
      lastPresetIndex: presetIndex,
    };
    store.set('appState', stateToSave);
  }

  function loadState() {
    const savedState = store.get('appState');
    if (savedState) {
        const p = presets[savedState.lastPresetIndex];
        state.seconds = p.seconds;
        state.totalSets = p.sets;
        state.setIndex = savedState.setIndex || 0;
        state.status = savedState.status || 'idle';
        state.remaining = savedState.remaining || state.seconds * 1000;
        state.workoutLogData = savedState.workoutLogData || [];
        presetIndex = savedState.lastPresetIndex || 0;

        if (state.status === 'running') {
            start();
        } else {
            updateUIFromState();
        }
    } else {
        selectPreset(presetIndex);
    }
  }
  
  window.addEventListener('pagehide', saveState);

  // ---------- Settings & Modals
  function applyAppearance(mode){
    root.className = mode;
    store.set('appearance', mode);
  }
  function openModal(modal){
    $$('.modal').forEach(m => m.classList.remove('active'));
    modal.classList.add('active');
  }
  function closeModal(modal){ modal.classList.remove('active'); }
  
  // NEW: Summary Modal Logic
  function showSummaryModal() {
    const totalActualTime = state.workoutLogData.reduce((sum, set) => sum + set.actualTime, 0);
    $('#summarySets').textContent = `${state.workoutLogData.length}/${state.totalSets}`;
    $('#summaryTime').textContent = minsSec(Math.round(totalActualTime/1000));
    openModal($('#summaryModal'));
  }
  
  $('#summaryDoneBtn').addEventListener('click', () => {
    closeModal($('#summaryModal'));
    state.setIndex = 0;
    updateSetPills();
    resetTimer(true); // Hard reset
  });

  // ---------- Event Listeners
  presetRow.addEventListener('click', (e)=>{
    const btn = e.target.closest('.preset-btn');
    if(btn){
      const index = parseInt(btn.dataset.index, 10);
      selectPreset(index, true);
    }
  });

  setRow.addEventListener('click', (e) => {
      const pill = e.target.closest('.pill');
      if (pill) {
          const index = parseInt(pill.dataset.set, 10);
          if (index < state.setIndex) {
              state.setIndex = index;
              resetTimer();
          }
      }
  });

  startBtn.addEventListener('click', toggleStart);
  minusBtn.addEventListener('click', () => nudger(-15000));
  plusBtn.addEventListener('click', () => nudger(15000));
  skipBtn.addEventListener('click', skip);
  backBtn.addEventListener('click', back);
  $('#clearLog').addEventListener('click', () => {
    saveLog([]);
    renderLog();
  });

  // Modal event listeners
  $('#customBtn').addEventListener('click', () => openModal($('#customModal')));
  $('#manageBtn').addEventListener('click', () => {
    renderPresetList();
    openModal($('#manageModal'));
  });
  $('#settingsBtn').addEventListener('click', () => openModal($('#settingsModal')));
  $$('.close-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));

  // Settings Toggles
  soundToggle.addEventListener('change', (e) => store.set('sounds', e.target.checked));
  notificationToggle.addEventListener('change', (e) => store.set('notifications', e.target.checked));

  // Theme buttons
  $('#lightMode').addEventListener('click', () => applyAppearance('light'));
  $('#darkMode').addEventListener('click', () => applyAppearance('dark'));
  $('#autoMode').addEventListener('click', () => applyAppearance('auto'));

  // Custom Preset Logic
  function parseTimeInput(input){
    const parts = input.split(':').map(Number);
    if(parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])){
      return parts[0] * 60 + parts[1];
    }
    return null;
  }
  $('#saveCustomBtn').addEventListener('click', () => {
    const timeStr = $('#timeInput').value.trim();
    const sets = parseInt($('#setsInput').value, 10);
    const seconds = parseTimeInput(timeStr);
    
    if (seconds !== null && seconds > 0 && sets > 0) {
      presets.push({ id: crypto.randomUUID(), seconds, sets });
      store.set('presets', presets);
      selectPreset(presets.length - 1);
      closeModal($('#customModal'));
    } else {
      console.error('Invalid input. Time must be in m:ss format and sets must be a positive number.');
    }
  });

  // Manage Presets Logic
  function renderPresetList() {
    $('#presetList').innerHTML = presets.map((p, i) => `
      <div class="modal-list-item">
        <span>${minsSec(p.seconds)} for ${p.sets} sets</span>
        <button class="delete-btn" data-id="${p.id}">×</button>
      </div>
    `).join('');
  }
  $('#presetList').addEventListener('click', (e) => {
    const btn = e.target.closest('.delete-btn');
    if (btn) {
      const idToDelete = btn.dataset.id;
      presets = presets.filter(p => p.id !== idToDelete);
      store.set('presets', presets);
      renderPresetList();
      selectPreset(0); // Select the first preset after deletion
    }
  });

  // Notification Permission
  function requestNotificationPermission() {
    if ('Notification' in window && notificationToggle.checked) {
      Notification.requestPermission();
    }
  }

  function showNotification(title, options) {
    if ('Notification' in window && notificationToggle.checked && Notification.permission === 'granted') {
      new Notification(title, options);
    }
  }

  // Initial render
  renderPresets();
  updateSetPills();
  updateControls();
  renderLog();
  loadState();
})();
</script>
</body>
</html>
