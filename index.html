<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Workout Rest Timer</title>
<link rel="icon" href="resttimer-roundcap-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
<link rel="icon" href="resttimer-roundcap-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
<style>
  :root{
    --bg: #0f1419;
    --card: #141a21;
    --text: #eaf0f6;
    --muted:#9fb0c1;
    --ring:#2e7cf7;
    --ring-15:#ff8a22;
    --accent:#2e7cf7;
    --accent-press:#1f66d6;
    --btn:#1a2230;
    --btn-text:#eaf0f6;
    --pill:#10161d;
    --pill-border:#243040;
    --shadow: 0 4px 12px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.1);
    --warn-fill: rgba(255,138,34,.15);
  }
  .light{
    --bg:#f6f8fb;
    --card:#fff;
    --text:#0f1419;
    --muted:#667b93;
    --ring:#2e7cf7;
    --ring-15:#ff8a22;
    --accent:#2e7cf7;
    --accent-press:#1f66d6;
    --btn:#dde6f1;
    --btn-text:#0f1419;
    --pill:#f6f8fb;
    --pill-border:#d9dfe6;
    --warn-fill: rgba(255,138,34,.15);
  }
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
    color:var(--text);
    background-color:var(--bg);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .card{
    background-color:var(--card);
    border-radius:24px;
    padding:24px;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    gap:24px;
    width:calc(100% - 48px);
    max-width:560px;
  }
  .container{
    display:flex;
    flex-direction:column;
    gap:24px;
  }
  .row{
    display:flex;
    flex-direction:row;
    gap:12px;
    justify-content:space-between;
    align-items:stretch;
  }
  .timer{
    display:flex;
    flex-direction:column;
    gap:16px;
    align-items:center;
    justify-content:center;
  }
  .timer.countdown{
    color:var(--accent);
  }
  .timer.warning{
    color:var(--ring-15);
  }
  .timer .digits{
    font-size:80px;
    font-variant-numeric:tabular-nums;
    font-weight:600;
  }
  .timer .label{
    font-size:20px;
    font-weight:500;
    text-transform:uppercase;
    color:var(--muted);
    letter-spacing:1px;
  }
  .buttons{
    display:flex;
    flex-direction:row;
    flex-wrap:wrap;
    gap:12px;
    justify-content:center;
  }
  .btn{
    cursor:pointer;
    border:none;
    border-radius:12px;
    padding:16px 24px;
    font-size:16px;
    font-weight:600;
    text-align:center;
    transition:background-color .2s;
    -webkit-tap-highlight-color:transparent;
  }
  .btn:active{
    transform:scale(0.98);
  }
  .btn-primary{
    background-color:var(--accent);
    color:var(--btn-text);
  }
  .btn-primary:active{
    background-color:var(--accent-press);
  }
  .btn-secondary{
    background-color:var(--btn);
    color:var(--btn-text);
  }
  .btn-ghost{
    background-color:transparent;
    color:var(--muted);
  }
  .btn-subtle{
    background-color:var(--pill);
    color:var(--btn-text);
    border:1px solid var(--pill-border);
  }
  .btn-subtle:active{
    background-color:rgba(255,255,255,.1);
  }
  .progress-ring{
    position:relative;
    width:240px;
    height:240px;
    transform:rotate(-90deg);
  }
  .progress-ring__circle{
    transition:stroke-dashoffset 0.35s;
    transform:rotate(-90deg);
    transform-origin:50% 50%;
  }
  .progress-ring__circle.background{
    stroke:var(--pill);
  }
  .progress-ring__circle.foreground{
    stroke:var(--ring);
  }
  .progress-ring__circle.warning{
    stroke:var(--ring-15);
  }
  .pill{
    background-color:var(--pill);
    border:1px solid var(--pill-border);
    border-radius:99px;
    padding:8px 16px;
    font-size:14px;
    font-weight:500;
    color:var(--muted);
  }
  .pill.active{
    background-color:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }
  .log{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .log-entry{
    display:flex;
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
    background-color:var(--pill);
    border:1px solid var(--pill-border);
    border-radius:12px;
    padding:16px;
  }
  .log-entry.warn{
    background-color:var(--warn-fill);
    border-color:var(--ring-15);
  }
  .log-entry.warn .log-name{
    color:var(--ring-15);
  }
  .log-name{
    font-weight:600;
  }
  .log-time{
    font-variant-numeric:tabular-nums;
    color:var(--muted);
  }
  .clear-log{
    display:flex;
    justify-content:center;
  }
  .clear-log button{
    color:var(--muted);
    font-size:14px;
  }
  .clear-log button:hover{
    text-decoration:underline;
  }
  .row-wrapper {
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  /* Custom styles to fix the layout for smaller devices */
  .main-control-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
  }

  /* Ensure all buttons can shrink to fit on a single line */
  .main-control-row .btn {
      flex-grow: 1; /* Allow all buttons to grow */
      flex-shrink: 1; /* Allow all buttons to shrink */
      min-width: 0; /* Important to allow them to shrink below their content size */
      white-space: nowrap; /* Prevent text wrapping */
      font-size: clamp(14px, 4vw, 16px); /* Optional: make font size responsive */
  }

  /* The primary button should not take up all space */
  .main-control-row .btn-primary {
      flex-grow: 2; /* Give the primary button more grow priority */
  }

</style>
</head>
<body class="light">
  <div class="card main">
    <div class="container">
      <div class="row presets">
        <button class="pill" data-preset-index="0">30s</button>
        <button class="pill" data-preset-index="1">45s</button>
        <button class="pill" data-preset-index="2">60s</button>
        <button class="pill" data-preset-index="3">90s</button>
      </div>

      <div class="timer">
        <svg class="progress-ring" viewBox="0 0 100 100">
          <circle class="progress-ring__circle background"
                  cx="50" cy="50" r="45" stroke-width="6"
                  fill="transparent"/>
          <circle class="progress-ring__circle foreground"
                  id="progress-ring-circle"
                  cx="50" cy="50" r="45" stroke-width="6"
                  fill="transparent"/>
        </svg>
        <div class="digits">--:--</div>
        <div class="label">Ready</div>
      </div>
      
      <div class="main-control-row">
        <button id="undoBtn" class="btn btn-ghost">Undo</button>
        <button id="minusBtn" class="btn btn-subtle">â€“15s</button>
        <button id="startBtn" class="btn btn-primary">Start</button>
        <button id="plusBtn" class="btn btn-subtle">+15s</button>
        <button id="nextBtn" class="btn btn-ghost">Skip</button>
      </div>

      <div class="log">
        <div class="log-entry" style="display: none;">
          <div class="log-name"></div>
          <div class="log-time"></div>
        </div>
      </div>

      <div class="clear-log">
        <button id="clearLogBtn" class="btn btn-ghost" style="display: none;">Clear Log</button>
      </div>

    </div>
  </div>

</body>
<script>
(() => {
  const store = {
    get: (key, fallback) => {
      try {
        const value = localStorage.getItem(key);
        if (value === null) return fallback;
        return JSON.parse(value);
      } catch (e) {
        console.error("Error reading from localStorage", e);
        return fallback;
      }
    },
    set: (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error("Error writing to localStorage", e);
      }
    }
  };

  const timer = document.querySelector('.timer');
  const digits = timer.querySelector('.digits');
  const label = timer.querySelector('.label');
  const presetsContainer = document.querySelector('.presets');
  const presetButtons = presetsContainer.querySelectorAll('.pill');
  const startBtn = document.getElementById('startBtn');
  const undoBtn = document.getElementById('undoBtn');
  const minusBtn = document.getElementById('minusBtn');
  const plusBtn = document.getElementById('plusBtn');
  const nextBtn = document.getElementById('nextBtn');
  const logContainer = document.querySelector('.log');
  const logEntryTemplate = logContainer.querySelector('.log-entry');
  const clearLogBtn = document.getElementById('clearLogBtn');
  const ring = document.getElementById('progress-ring-circle');

  const circumference = 2 * Math.PI * 45;
  ring.style.strokeDasharray = circumference;

  const presets = [
    { name: '30s', duration: 30000 },
    { name: '45s', duration: 45000 },
    { name: '60s', duration: 60000 },
    { name: '90s', duration: 90000 },
  ];
  let presetIndex = store.get('presetIndex', 0);
  let timerId = null;

  const state = {
    remaining: presets[presetIndex].duration,
    original: presets[presetIndex].duration,
    isRunning: false,
    workoutLog: store.get('workoutLog', []),
    workoutLetterIndex: store.get('workoutLetterIndex', 0),
  };

  const getLog = () => store.get('workoutLog', []);
  const saveLog = (log) => store.set('workoutLog', log);

  const formatTime = ms => {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    const format = num => String(num).padStart(2, '0');
    return `${format(minutes)}:${format(seconds)}`;
  };

  const updateDisplay = () => {
    const totalTime = state.original;
    const remainingTime = state.remaining;
    const offset = circumference - (remainingTime / totalTime) * circumference;
    ring.style.strokeDashoffset = offset;
    
    digits.textContent = formatTime(remainingTime);
    
    if (remainingTime <= 15000 && remainingTime > 0) {
      timer.classList.add('warning');
      ring.classList.add('warning');
    } else {
      timer.classList.remove('warning');
      ring.classList.remove('warning');
    }

    if (state.isRunning) {
      startBtn.textContent = 'Pause';
      startBtn.classList.add('btn-secondary');
      startBtn.classList.remove('btn-primary');
      label.textContent = `Set ${state.workoutLog.length + 1}`;
    } else {
      startBtn.textContent = 'Start';
      startBtn.classList.add('btn-primary');
      startBtn.classList.remove('btn-secondary');
      label.textContent = state.remaining === state.original ? 'Ready' : 'Paused';
    }
  };

  const tick = () => {
    if (state.remaining <= 0) {
      endTimer();
      return;
    }
    state.remaining -= 100;
    updateDisplay();
  };

  const startTimer = () => {
    if (state.isRunning) return;
    state.isRunning = true;
    timerId = setInterval(tick, 100);
    startBtn.textContent = 'Pause';
    updateDisplay();
  };

  const pauseTimer = () => {
    if (!state.isRunning) return;
    state.isRunning = false;
    clearInterval(timerId);
    timerId = null;
    startBtn.textContent = 'Resume';
    updateDisplay();
  };

  const endTimer = () => {
    pauseTimer();
    const log = getLog();
    log.push({
      time: state.original - state.remaining,
      name: presets[presetIndex].name,
      completed: true
    });
    saveLog(log);
    renderLog();
    state.remaining = presets[presetIndex].duration;
    state.original = presets[presetIndex].duration;
    updateDisplay();
  };

  const resetTimer = () => {
    pauseTimer();
    state.remaining = state.original;
    updateDisplay();
  };

  const nudger = (ms) => {
    state.remaining = Math.max(0, state.remaining + ms);
    state.original = Math.max(0, state.original + ms);
    updateDisplay();
  };

  const undo = () => {
    const log = getLog();
    log.pop();
    saveLog(log);
    renderLog();
    // Do not reset timer state here, just remove the log entry.
  };

  const renderPresets = () => {
    presetButtons.forEach((btn, index) => {
      btn.textContent = presets[index].name;
      btn.onclick = () => selectPreset(index);
    });
  };

  const selectPreset = (index) => {
    presetButtons.forEach((btn, btnIndex) => {
      btn.classList.toggle('active', index === btnIndex);
    });
    presetIndex = index;
    store.set('presetIndex', presetIndex);
    pauseTimer();
    state.remaining = presets[presetIndex].duration;
    state.original = presets[presetIndex].duration;
    updateDisplay();
  };
  
  const renderLog = () => {
    const log = getLog();
    logContainer.innerHTML = '';
    const tempDiv = document.createElement('div');
    
    if (log.length > 0) {
      log.forEach(entry => {
        const clone = logEntryTemplate.cloneNode(true);
        clone.style.display = 'flex';
        clone.querySelector('.log-name').textContent = entry.name;
        clone.querySelector('.log-time').textContent = formatTime(entry.time);
        tempDiv.appendChild(clone);
      });
      clearLogBtn.style.display = 'flex';
    } else {
      clearLogBtn.style.display = 'none';
    }

    logContainer.appendChild(tempDiv);
  };

  // Event Listeners
  startBtn.addEventListener('click', () => {
    if (state.isRunning) {
      pauseTimer();
    } else {
      startTimer();
    }
  });

  nextBtn.addEventListener('click', endTimer);
  undoBtn.addEventListener('click', undo);
  minusBtn.addEventListener('click', () => nudger(-15000));
  plusBtn.addEventListener('click', () => nudger(15000));
  clearLogBtn.addEventListener('click', () => {
    saveLog([]);
    renderLog();
    store.set('workoutLetterIndex', 0);
    state.workoutLetterIndex = 0;
  });

  renderPresets();
  selectPreset(presetIndex);
  renderLog();

  setInterval(() => {
    if (!isFinite(state.remaining)) resetTimer();
    if (!digits.textContent || digits.textContent.includes('NaN')) {
      digits.textContent = formatTime(state.remaining);
    }
  }, 500);

})();
</script>

<script>
// Register service worker for offline/installability
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed', err));
  });
}

// Keep screen awake during use (iOS 16+ supports Screen Wake Lock)
let screenWakeLock = null;
async function requestWakeLock() {
  try {
    screenWakeLock = await navigator.wakeLock.request('screen');
    screenWakeLock.addEventListener('release', () => { screenWakeLock = null; });
  } catch (e) { console.log('WakeLock unavailable', e); }
}
// Acquire on first tap; re-acquire when returning to app
window.addEventListener('pointerdown', requestWakeLock, {once: true});
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && !screenWakeLock) {
    requestWakeLock();
  }
});
</script>
</html>
