<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Workout Rest Timer</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E⏱️%3C/text%3E%3C/svg%3E">
<style>
  :root {
    --bg: #0f1419;
    --card: #141a21;
    --text: #eaf0f6;
    --muted: #9fb0c1;
    --ring: #2e7cf7;
    --ring-15: #ff8a22;
    --accent: #2e7cf7;
    --accent-press: #1f66d6;
    --btn: #1a2230;
    --btn-text: #eaf0f6;
    --pill: #10161d;
    --pill-border: #243040;
    --shadow: 0 4px 12px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.1);
    --warn-fill: rgba(255,138,34,.15);
  }
  .light {
    --bg: #f6f8fb;
    --card: #ffffff;
    --text: #0b1722;
    --muted: #6b7c8d;
    --ring: #1f6eff;
    --ring-15: #ff7a1a;
    --accent: #1f6eff;
    --accent-press: #0d50cc;
    --btn: #e6edf6;
    --btn-text: #0b1722;
    --pill: #e8effa;
    --pill-border: #d1dbe7;
    --warn-fill: rgba(255,122,26,.15);
  }
  .auto {
    color-scheme: light dark;
  }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    font-size: 16px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  .wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 400px;
    gap: 20px;
  }
  .timer-card {
    background: var(--card);
    border-radius: 24px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    width: 100%;
    box-sizing: border-box;
  }
  .time-display {
    width: clamp(180px, 50vw, 220px);
    height: clamp(180px, 50vw, 220px);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .time-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 12px solid var(--pill-border);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .time-progress {
    position: absolute;
    width: calc(100% + 20px);
    height: calc(100% + 20px);
    top: -10px;
    left: -10px;
    transform: rotate(-90deg);
  }
  .time-progress circle {
    fill: transparent;
    stroke-linecap: round;
    transition: stroke-dashoffset .35s;
    stroke-width: 12;
    stroke: var(--ring);
  }
  .time-progress circle.warn {
    stroke: var(--ring-15);
  }
  .time-digits {
    font-size: clamp(2.5rem, 8vw, 3rem);
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }
  .time-label {
    font-size: 1rem;
    font-weight: 400;
    margin-top: -5px;
    color: var(--muted);
  }
  .controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-top: 20px;
    flex-wrap: wrap; /* Added for responsiveness */
  }
  .controls button {
    width: 60px;
    height: 60px;
    background: var(--btn);
    border: none;
    border-radius: 50%;
    color: var(--btn-text);
    font-size: 24px;
    cursor: pointer;
    transition: transform .2s ease-in-out, background .2s ease-in-out;
    box-shadow: var(--shadow);
  }
  .controls button:hover {
    transform: scale(1.05);
  }
  .controls button:active {
    transform: scale(.95);
  }
  .main-control {
    flex-grow: 1; /* Changed from fixed width to flexible */
    height: 60px;
    border-radius: 30px;
    background: var(--accent);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    text-shadow: 0 1px 1px rgba(0,0,0,.15);
    padding: 0 20px;
    transition: background .2s ease-in-out;
  }
  .main-control:hover {
    background: var(--accent-press);
  }
  .log {
    display: flex;
    flex-direction: column;
    width: 100%;
    margin-top: 20px;
    gap: 10px;
  }
  .log-item {
    background: var(--pill);
    border: 1px solid var(--pill-border);
    border-radius: 16px;
    padding: 10px 20px;
    font-size: .9rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .log-item-content {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-grow: 1;
  }
  .log-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
  }
  .log-item.complete .log-icon {
    background: var(--ring);
  }
  .log-item.skipped .log-icon {
    background: var(--ring-15);
  }
  .log-item-content span {
    font-weight: 700;
  }
  .log-buttons {
    display: flex;
    gap: 5px;
  }
  .log-buttons button {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    transition: color .2s;
  }
  .log-buttons button:hover {
    color: var(--text);
  }
  .pills {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    width: 100%;
    margin-top: 20px;
  }
  .pills button {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--pill-border);
    background: var(--pill);
    color: var(--text);
    cursor: pointer;
    transition: background .2s, border-color .2s;
  }
  .pills button.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .pills button:hover:not(.selected) {
    background: var(--pill-border);
  }
  .settings-icon {
    width: 24px;
    height: 24px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    transition: color .2s;
  }
  .settings-icon:hover {
    color: var(--text);
  }
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity .3s, visibility .3s;
    z-index: 1000;
  }
  .modal.active {
    opacity: 1;
    visibility: visible;
  }
  .modal-content {
    background: var(--card);
    padding: 20px;
    border-radius: 24px;
    box-shadow: var(--shadow);
    max-width: 350px;
    width: 90%;
    display: flex;
    flex-direction: column;
    gap: 15px;
    position: relative;
  }
  .modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
  }
  .modal-header {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 10px;
  }
  .modal-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .modal-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--pill);
    border-radius: 12px;
    border: 1px solid var(--pill-border);
  }
  .modal-list-item button {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
  }
  .modal-actions button {
    flex-grow: 1;
    height: 40px;
    border-radius: 20px;
    border: none;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
  }
  .modal-actions button.secondary {
    background: var(--pill-border);
    color: var(--text);
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .form-group label {
    font-size: .9rem;
    color: var(--muted);
  }
  .form-group input {
    background: var(--pill);
    border: 1px solid var(--pill-border);
    border-radius: 12px;
    padding: 10px;
    color: var(--text);
  }
  .btn-group {
    display: flex;
    gap: 10px;
  }
  .btn-group button {
    flex-grow: 1;
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--pill-border);
    background: var(--pill);
    color: var(--text);
    cursor: pointer;
  }
  .btn-group button.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .enable-notifications-btn {
    width: 100%;
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    background: var(--ring);
    color: white;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  @media(max-width: 480px) {
    body {
      padding: 10px;
    }
    .timer-card {
      padding: 20px;
    }
    .time-digits {
      font-size: clamp(2rem, 8vw, 3rem);
    }
    .time-display {
      width: clamp(160px, 50vw, 200px);
      height: clamp(160px, 50vw, 200px);
    }
    .controls {
      flex-wrap: wrap; /* ensures buttons wrap on small screens */
      gap: 8px;
    }
    .controls button {
      width: 50px;
      height: 50px;
    }
    .main-control {
      flex-grow: 1;
      height: 50px;
    }
    .pills {
      gap: 8px;
    }
    .pills button {
      padding: 6px 12px;
    }
    .modal-content {
      width: 95%;
    }
  }
</style>
</head>
<body class="auto">

<div class="wrapper">
  <div style="display:flex; justify-content:space-between; width:100%;">
    <div style="width:24px;"></div>
    <div style="display:flex; align-items:center; gap:8px;">
      <button id="presetsBtn" class="settings-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 21v-7"/></svg>
      </button>
      <button id="settingsBtn" class="settings-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.52a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.28a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2-0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.28a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.52a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.78-1.28a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
    </div>
  </div>

  <div class="timer-card">
    <div class="time-display">
      <div class="time-circle">
        <span id="timeDigits" class="time-digits">00:00</span>
        <span id="countdownLabel" class="time-label">Set 1 of 1</span>
      </div>
      <svg id="timeProgress" class="time-progress" viewBox="0 0 240 240">
        <circle cx="120" cy="120" r="110"/>
      </svg>
    </div>
  </div>

  <div class="controls">
    <button id="minusBtn" class="circle-btn">-15s</button>
    <button id="startBtn" class="main-control">Start</button>
    <button id="plusBtn" class="circle-btn">+15s</button>
  </div>

  <div class="pills" id="pills"></div>
  <div class="log" id="log"></div>
</div>

<div id="presetsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Presets</div>
    <button class="modal-close close-btn">&times;</button>
    <div id="presetList" class="modal-list"></div>
    <div class="modal-actions">
      <button id="addPresetBtn">Add Current</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Settings</div>
    <button class="modal-close close-btn">&times;</button>
    <div class="form-group">
      <label>Appearance</label>
      <div class="btn-group">
        <button id="lightMode">Light</button>
        <button id="darkMode">Dark</button>
        <button id="autoMode">Auto</button>
      </div>
    </div>
    <button id="enableNotificationsBtn" class="enable-notifications-btn">Enable Notifications</button>
    <div class="modal-actions">
      <button id="clearLogBtn" class="secondary">Clear Log</button>
    </div>
  </div>
</div>

<div id="addPresetModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Add New Preset</div>
    <div class="form-group">
      <label for="presetSeconds">Rest Time (seconds)</label>
      <input type="number" id="presetSeconds" value="60" min="1" step="1">
    </div>
    <div class="form-group">
      <label for="presetSets">Number of Sets</label>
      <input type="number" id="presetSets" value="1" min="1" step="1">
    </div>
    <div class="modal-actions">
      <button id="savePresetBtn">Save Preset</button>
      <button id="cancelPresetBtn" class="secondary">Cancel</button>
    </div>
    </div>
</div>

<div id="messageBox" class="modal">
  <div class="modal-content">
    <div id="messageText" class="modal-header"></div>
    <div class="modal-actions">
      <button class="close-btn">OK</button>
    </div>
  </div>
</div>

<script>
// This is the core timer logic that will run in a Web Worker.
// It is embedded as a Blob for single-file deployment.
const workerScript = `
let timerId;
let remaining;
let endTime;

function tick() {
  const now = Date.now();
  remaining = endTime - now;

  if (remaining <= 0) {
    self.postMessage({ type: 'DONE', remaining: 0 });
    clearInterval(timerId);
    timerId = null;
    return;
  }
  self.postMessage({ type: 'TICK', remaining });
}

self.onmessage = function(e) {
  const data = e.data;
  if (data.type === 'START') {
    if (timerId) clearInterval(timerId);
    remaining = data.duration;
    endTime = Date.now() + remaining;
    timerId = setInterval(tick, 100);
  } else if (data.type === 'PAUSE') {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
      self.postMessage({ type: 'PAUSED', remaining: remaining });
    }
  } else if (data.type === 'RESUME') {
    if (remaining > 0) {
      endTime = Date.now() + remaining;
      timerId = setInterval(tick, 100);
    }
  } else if (data.type === 'UPDATE_TIME') {
    remaining = Math.max(0, data.remaining);
    if (timerId) {
      endTime = Date.now() + remaining;
      self.postMessage({ type: 'TICK', remaining });
    }
  } else if (data.type === 'STOP') {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }
};
`;

// Helper functions for DOM and localStorage
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const store = {
  get: (key, defaultValue) => {
    try {
      const value = localStorage.getItem(key);
      return value === null ? defaultValue : JSON.parse(value);
    } catch (e) {
      console.error('Error getting from localStorage', e);
      return defaultValue;
    }
  },
  set: (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.error('Error setting to localStorage', e);
    }
  }
};

// State management
const state = {
  remaining: 0,
  isRunning: false,
  setsCompleted: 0,
  log: store.get('log', []),
  notificationPermission: Notification.permission
};

const defaultPresets = [
  { seconds: 30, sets: 1 },
  { seconds: 45, sets: 1 },
  { seconds: 60, sets: 1 },
];
let presets = store.get('presets', defaultPresets);
let presetIndex = store.get('presetIndex', 0);
let screenWakeLock = null;

// Audio context
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const gainNode = audioContext.createGain();
gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
gainNode.connect(audioContext.destination);

function playBeep(frequency = 440, duration = 0.5, volume = 0.5) {
  const oscillator = audioContext.createOscillator();
  const beepGain = audioContext.createGain();
  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  beepGain.gain.setValueAtTime(volume, audioContext.currentTime);
  oscillator.connect(beepGain);
  beepGain.connect(audioContext.destination);
  oscillator.start();
  oscillator.stop(audioContext.currentTime + duration);
}

function playAlarm() {
  playBeep(440, 0.5, 0.5);
  setTimeout(() => playBeep(660, 0.5, 0.5), 500);
}

// UI elements
const timeDigits = $('#timeDigits');
const countdownLabel = $('#countdownLabel');
const startBtn = $('#startBtn');
const presetsBtn = $('#presetsBtn');
const settingsBtn = $('#settingsBtn');
const presetsModal = $('#presetsModal');
const addPresetModal = $('#addPresetModal');
const settingsModal = $('#settingsModal');
const presetList = $('#presetList');
const logEl = $('#log');
const timeProgress = $('#timeProgress circle');
const pillsEl = $('#pills');
const messageBox = $('#messageBox');
const messageText = $('#messageText');
const minusBtn = $('#minusBtn');
const plusBtn = $('#plusBtn');
const clearLogBtn = $('#clearLogBtn');
const enableNotificationsBtn = $('#enableNotificationsBtn');
const addPresetBtn = $('#addPresetBtn');
const savePresetBtn = $('#savePresetBtn');
const cancelPresetBtn = $('#cancelPresetBtn');
const presetSecondsInput = $('#presetSeconds');
const presetSetsInput = $('#presetSets');

// Web Worker setup
const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
const workerUrl = URL.createObjectURL(workerBlob);
const timerWorker = new Worker(workerUrl);

// Update UI based on worker messages
timerWorker.onmessage = (e) => {
  const data = e.data;
  if (data.type === 'TICK') {
    state.remaining = data.remaining;
    updateTimerDisplay();
  } else if (data.type === 'DONE') {
    state.remaining = 0;
    state.isRunning = false;
    releaseWakeLock();
    startBtn.textContent = 'Start';
    startBtn.disabled = false;
    updateTimerDisplay();
    playAlarm();
    addLogEntry('complete');
    if (state.notificationPermission === 'granted') {
        showNotification();
    }
  }
};

// Helper for opening/closing modals
function openModal(modal) {
  modal.classList.add('active');
}
function closeModal(modal) {
  modal.classList.remove('active');
}
function showMessageBox(message) {
  messageText.textContent = message;
  openModal(messageBox);
}

// UI Rendering
function formatTime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function renderPresets() {
  pillsEl.innerHTML = presets.map((p, i) =>
    `<button class="${i === presetIndex ? 'selected' : ''}" data-index="${i}">${formatTime(p.seconds * 1000)}</button>`
  ).join('');
}

function renderLog() {
  logEl.innerHTML = state.log.map(entry =>
    `<div class="log-item ${entry.status}">
      <div class="log-item-content">
        <span class="log-icon"></span>
        <span>${formatTime(entry.seconds * 1000)}</span>
        <span>Set ${entry.set} of ${entry.totalSets}</span>
      </div>
      <div class="log-buttons">
        <button data-status="${entry.status}" data-set="${entry.set}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </button>
      </div>
    </div>`
  ).join('');
}

function selectPreset(index) {
  presetIndex = index;
  store.set('presetIndex', presetIndex);
  resetTimer();
  renderPresets();
}

function resetTimer() {
  timerWorker.postMessage({ type: 'STOP' });
  state.remaining = presets[presetIndex].seconds * 1000;
  state.setsCompleted = 0;
  startBtn.textContent = 'Start';
  startBtn.disabled = false;
  updateTimerDisplay();
}

function addLogEntry(status) {
  const newEntry = {
    seconds: presets[presetIndex].seconds,
    totalSets: presets[presetIndex].sets,
    set: state.setsCompleted + 1,
    status: status
  };
  state.log.unshift(newEntry);
  state.log = state.log.slice(0, 10);
  store.set('log', state.log);
  renderLog();
}

// Timer Controls
function toggleStart() {
  state.isRunning = !state.isRunning;
  if (state.isRunning) {
    timerWorker.postMessage({ type: 'START', duration: state.remaining });
    startBtn.textContent = 'Pause';
    requestWakeLock();
  } else {
    timerWorker.postMessage({ type: 'PAUSE' });
    startBtn.textContent = 'Resume';
    releaseWakeLock();
  }
}

function nudger(amount) {
  let newRemaining = state.remaining + amount;
  newRemaining = Math.max(0, newRemaining);
  newRemaining = Math.min(newRemaining, 99 * 60 * 1000); // Max 99 minutes
  state.remaining = newRemaining;
  timerWorker.postMessage({ type: 'UPDATE_TIME', remaining: state.remaining });
  updateTimerDisplay();
}

// Wake Lock
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator && !screenWakeLock) {
      screenWakeLock = await navigator.wakeLock.request('screen');
      screenWakeLock.addEventListener('release', () => { screenWakeLock = null; });
    }
  } catch (e) {
    console.log('WakeLock unavailable', e);
  }
}
function releaseWakeLock() {
  if (screenWakeLock) {
    screenWakeLock.release().then(() => { screenWakeLock = null; });
  }
}
document.addEventListener('visibilitychange', () => {
  if (state.isRunning) {
    if (document.visibilityState === 'visible') {
      timerWorker.postMessage({ type: 'RESUME' });
      requestWakeLock();
    } else {
      timerWorker.postMessage({ type: 'PAUSE' });
      releaseWakeLock();
    }
  }
});

// Notifications
function showNotification() {
  new Notification("Workout Timer", {
    body: "Your rest is over! Time to start your next set."
  });
}

// Event Listeners
pillsEl.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (btn) {
    selectPreset(parseInt(btn.dataset.index, 10));
  }
});

presetsBtn.addEventListener('click', () => {
  // Re-render the list on open
  presetList.innerHTML = presets.map((p, i) =>
    `<div class="modal-list-item" data-index="${i}">
      <span>${formatTime(p.seconds * 1000)} ×${p.sets}</span>
      <button class="delete-btn" data-index="${i}">&times;</button>
    </div>`
  ).join('');
  openModal(presetsModal);
});

addPresetBtn.addEventListener('click', () => {
  openModal(addPresetModal);
});

savePresetBtn.addEventListener('click', () => {
  const seconds = parseInt(presetSecondsInput.value, 10);
  const sets = parseInt(presetSetsInput.value, 10);
  if (!isNaN(seconds) && seconds > 0 && !isNaN(sets) && sets > 0) {
    presets.push({ seconds, sets });
    store.set('presets', presets);
    renderPresets();
    showMessageBox("Preset added successfully!");
    closeModal(addPresetModal);
  } else {
    showMessageBox("Invalid input. Please enter positive numbers for both fields.");
  }
});

cancelPresetBtn.addEventListener('click', () => {
  closeModal(addPresetModal);
});

presetList.addEventListener('click', (e) => {
  if (e.target.classList.contains('delete-btn')) {
    const index = parseInt(e.target.dataset.index, 10);
    presets.splice(index, 1);
    store.set('presets', presets);
    renderPresets();
    showMessageBox("Preset deleted.");
  }
});

// Settings Modal
settingsBtn.addEventListener('click', () => {
  openModal(settingsModal);
});
$('#lightMode').addEventListener('click', () => applyAppearance('light'));
$('#darkMode').addEventListener('click', () => applyAppearance('dark'));
$('#autoMode').addEventListener('click', () => applyAppearance('auto'));
enableNotificationsBtn.addEventListener('click', async () => {
  if (!("Notification" in window)) {
    showMessageBox("This browser does not support desktop notifications.");
    return;
  }
  const permission = await Notification.requestPermission();
  state.notificationPermission = permission;
  if (permission === 'granted') {
    showMessageBox("Notifications are now enabled! Please ensure your phone is not on silent/mute to hear the alarm sound.");
  } else {
    showMessageBox("Notifications were denied. You can enable them in your browser settings if you change your mind.");
  }
});

function applyAppearance(mode) {
  document.body.className = mode;
  store.set('appearance', mode);
}
applyAppearance(store.get('appearance', 'auto'));

// Universal close button for modals
$$('.close-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    closeModal(e.target.closest('.modal'));
  });
});

startBtn.addEventListener('click', toggleStart);
minusBtn.addEventListener('click', () => nudger(-15000));
plusBtn.addEventListener('click', () => nudger(15000));
clearLogBtn.addEventListener('click', () => {
  state.log = [];
  store.set('log', []);
  renderLog();
});

// Initial render
selectPreset(presetIndex);
renderLog();
updateTimerDisplay();
</script>

</body>
</html>
